"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),require("polythene/common/object.assign");var _polythene=require("polythene/polythene/polythene"),_polythene2=_interopRequireDefault(_polythene),_events=require("polythene/common/events"),_events2=_interopRequireDefault(_events),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril),_button=require("polythene/button/button"),_button2=_interopRequireDefault(_button),_icon=require("polythene/icon/icon"),_icon2=_interopRequireDefault(_icon),_iconButton=require("polythene/icon-button/icon-button"),_iconButton2=_interopRequireDefault(_iconButton),_scrollTo=require("polythene/common/scroll-to"),_scrollTo2=_interopRequireDefault(_scrollTo),_theme=require("polythene/tabs/theme/theme"),_theme2=_interopRequireDefault(_theme),_config=require("polythene/tabs/theme/config"),_config2=_interopRequireDefault(_config),CSS_CLASSES={block:"pe-tabs",scrollButton:"pe-tabs__scroll-button",scrollButtonLeft:"pe-tabs__scroll-button--start",scrollButtonRight:"pe-tabs__scroll-button--end",scrollButtonOffset:"pe-tabs__scroll-button--offset",tabRow:"pe-tabs__row",tabRowCentered:"pe-tabs__row--centered",tabRowIndent:"pe-tabs__row--indent",tab:"pe-tabs__tab",tabContent:"pe-tabs__tab-content",tabHasIcon:"pe-tabs__tab---icon",indicator:"pe-tabs__indicator",scrollable:"pe-tabs--scrollable",isAutofit:"pe-tabs--autofit",isAtStart:"pe-tabs--start",isAtEnd:"pe-tabs--end",isMenu:"pe-tabs--menu",isSmall:"pe-tabs--small",activeSelected:"pe-tabs__active-selected",label:"pe-button__label"},POSITION_LEFT=2,POSITION_RIGHT=4,getNewIndex=function(index,tabs){var minTabIndex=0,maxTabIndex=tabs.length-1;return{left:Math.max(index-1,minTabIndex),right:Math.min(index+1,maxTabIndex)}},handleScrollButtonClick=function(ctrl,opts,e,direction){e.stopPropagation(),e.preventDefault();var tabs=ctrl.tabs,currentTabIndex=ctrl.selectedTabIndex,newIndex=getNewIndex(currentTabIndex,tabs)[direction];scrollToTab(ctrl,newIndex),newIndex!==currentTabIndex&&(setSelectedTab(ctrl,opts,newIndex,!0),_mithril2.default.redraw())},createScrollButton=function(ctrl,position,opts){var scrollIconForward=opts.scrollIconForward||_theme2.default.arrowForward,scrollIconBackward=opts.scrollIconBackward||_theme2.default.arrowBackward;return _mithril2.default.component(_iconButton2.default,{class:[CSS_CLASSES.scrollButton,position===POSITION_LEFT?CSS_CLASSES.scrollButtonLeft:CSS_CLASSES.scrollButtonRight].join(" "),icon:position===POSITION_LEFT?scrollIconBackward:scrollIconForward,ripple:{center:!0},config:function(el){ctrl.scrollButtonLeftEl&&ctrl.scrollButtonRightEl||(position===POSITION_LEFT?ctrl.scrollButtonLeftEl=el:ctrl.scrollButtonRightEl=el)},events:{onclick:position===POSITION_LEFT?function(e){handleScrollButtonClick(ctrl,opts,e,"left")}:function(e){handleScrollButtonClick(ctrl,opts,e,"right")}}})},alignToTitle=function(ctrl){var firstTab=ctrl.tabs[0].el,firstInnerLabel=firstTab.querySelector("."+CSS_CLASSES.label+" span"),firstOuterLabelWidth=firstTab.getBoundingClientRect().width,firstInnerLabelWidth=firstInnerLabel.getBoundingClientRect().width,firstTabOffset=(firstOuterLabelWidth-firstInnerLabelWidth)/2;firstTab.style.marginLeft=-firstTabOffset+"px"},createRightButtonOffset=function(ctrl){var scrollButtonRightWidth=ctrl.scrollButtonRightEl.getBoundingClientRect().width,scrollButtonOffsetEl=ctrl.tabsEl.querySelector("."+CSS_CLASSES.scrollButtonOffset);scrollButtonOffsetEl.style.width=scrollButtonRightWidth+"px"},scrollToTab=function(ctrl,tabIndex){var tabs=ctrl.tabs,scroller=ctrl.scrollerEl,tabLeft=tabs.slice(0,tabIndex).reduce(function(totalWidth,tabData){return totalWidth+tabData.el.getBoundingClientRect().width},0),scrollerWidth=scroller.getBoundingClientRect().width,scrollingWidth=scroller.scrollWidth,maxScroll=scrollingWidth-scrollerWidth,left=Math.min(tabLeft,maxScroll),currentLeft=scroller.scrollLeft;currentLeft!==left&&!function(){var duration=Math.abs(currentLeft-left)/_config2.default.tabs_scroll_speed,delaySeconds=_config2.default.tabs_scroll_delay||0;setTimeout(function(){(0,_scrollTo2.default)({element:scroller,to:left,duration:Math.max(_config2.default.tabs_scroll_min_duration,duration),direction:"horizontal"})},1e3*delaySeconds)}()},updateScrollButtons=function(ctrl){var scrollerEl=ctrl.scrollerEl,scrollLeft=scrollerEl.scrollLeft,currentTabIndex=ctrl.selectedTabIndex,tabs=ctrl.tabs,tabsEl=ctrl.tabsEl,minTabIndex=0,maxTabIndex=tabs.length-1,isAtLeft=0===scrollerEl.scrollLeft&&currentTabIndex===minTabIndex,isAtRight=scrollLeft>=scrollerEl.scrollWidth-tabsEl.getBoundingClientRect().width-1&&currentTabIndex===maxTabIndex;ctrl.scrollButtonStates.left=!isAtLeft,ctrl.scrollButtonStates.right=!isAtRight},animateIndicator=function(selectedTabEl,animate,ctrl){var parentRect=ctrl.tabsEl.getBoundingClientRect(),rect=selectedTabEl.getBoundingClientRect(),style=ctrl.tabIndicatorEl.style,translateX=rect.left-parentRect.left+ctrl.scrollerEl.scrollLeft,transformCmd="translate("+translateX+"px, 0)",duration=animate?_config2.default.indicator_slide_min_duration:0;style.width=rect.width+"px",style["transition-duration"]=style["-webkit-transition-duration"]=style["-moz-transition-duration"]=style["-o-transition-duration"]=duration+"s",style.transform=style["-webkit-transform"]=style["-moz-transform"]=style["-ms-transform"]=style["-o-transform"]=transformCmd},setSelectedTab=function(ctrl,opts,index,animate){if(ctrl.selectedTabIndex=index,ctrl.tabs.length){var selectedTabEl=ctrl.tabs[index].el;selectedTabEl&&ctrl.tabIndicatorEl&&ctrl.tabsEl&&animateIndicator(selectedTabEl,animate,ctrl),ctrl.managesScroll&&(updateScrollButtons(ctrl),scrollToTab(ctrl,index)),opts.getState&&opts.getState({index:index,data:ctrl.tabs[index].data,el:selectedTabEl})}},createTab=function(ctrl,opts,index,buttonOpts){buttonOpts.events=buttonOpts.events||{},buttonOpts.events.onclick=buttonOpts.events.onclick||function(){};var tabButtonOptions=Object.assign({},buttonOpts,{content:(0,_mithril2.default)("div",{class:CSS_CLASSES.tabContent},[buttonOpts.icon?_mithril2.default.component(_icon2.default,buttonOpts.icon):null,buttonOpts.label?(0,_mithril2.default)("div",{class:CSS_CLASSES.label},(0,_mithril2.default)("span",buttonOpts.label)):null]),class:[CSS_CLASSES.tab,buttonOpts.icon&&buttonOpts.label?CSS_CLASSES.tabHasIcon:null,buttonOpts.class].join(" "),wash:!1,ripple:!0,events:Object.assign({},buttonOpts.events,{onclick:function(e){setSelectedTab(ctrl,opts,index,!opts.noIndicatorSlide),buttonOpts.events.onclick(e)}}),config:function(el,inited){inited||ctrl.tabs.push({data:buttonOpts,el:el})}});return _mithril2.default.component(_button2.default,tabButtonOptions)},sortNumbers=function(a,b){return a<b?-1:a>b?1:0},createView=function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},tag=opts.tag||"div",autofit=!opts.scrollable&&!opts.centered&&!!opts.autofit;void 0!==opts.selectedTab&&ctrl.previousOptsSelectedTab!==opts.selectedTab&&setSelectedTab(ctrl,opts,opts.selectedTab,!0),ctrl.previousOptsSelectedTab=opts.selectedTab;var props={class:[CSS_CLASSES.block,opts.scrollable?CSS_CLASSES.scrollable:null,0===ctrl.selectedTabIndex?CSS_CLASSES.isAtStart:null,ctrl.selectedTabIndex===ctrl.tabs.length-1?CSS_CLASSES.isAtEnd:null,opts.activeSelected?CSS_CLASSES.activeSelected:null,autofit?CSS_CLASSES.isAutofit:null,opts.menu?CSS_CLASSES.isMenu:null,opts.small?CSS_CLASSES.isSmall:null,opts.class].join(" "),id:opts.id||"",config:function(el,inited,context){if(!inited){ctrl.tabsEl=el,opts.largestWidth&&!function(){var widths=ctrl.tabs.map(function(tabData){return tabData.el.getBoundingClientRect().width}),largest=widths.sort(sortNumbers).reverse()[0];ctrl.tabs.forEach(function(tabData){return tabData.el.style.width=largest+"px"})}(),opts.scrollable&&alignToTitle(ctrl),opts.scrollable&&!_polythene2.default.isTouch&&(ctrl.managesScroll=!0,createRightButtonOffset(ctrl));var onResize=function(){setSelectedTab(ctrl,opts,ctrl.selectedTabIndex,!1),_mithril2.default.redraw()};_events2.default.subscribe("resize",onResize),context.onunload=function(){_events2.default.unsubscribe("resize",onResize)},setSelectedTab(ctrl,opts,ctrl.selectedTabIndex,!1)}}},tabRow=opts.buttons.map(function(buttonOpts,index){var buttonOptsCombined=Object.assign({},buttonOpts,{selected:index===ctrl.selectedTabIndex,animateOnTap:opts.animateOnTap!==!1},opts.tabsOpts||{});return createTab(ctrl,opts,index,buttonOptsCombined)}).concat([opts.scrollable?(0,_mithril2.default)("div",{class:CSS_CLASSES.scrollButtonOffset}):null]),scrollButtonLeft=void 0,scrollButtonRight=void 0;opts.scrollable&&(scrollButtonLeft=createScrollButton(ctrl,POSITION_LEFT,opts),scrollButtonRight=createScrollButton(ctrl,POSITION_RIGHT,opts));var tabIndicator=opts.hideIndicator?null:(0,_mithril2.default)("div",{class:CSS_CLASSES.indicator,config:function(el,inited){inited||(ctrl.tabIndicatorEl=el)}}),content=[opts.scrollable?scrollButtonLeft:null,(0,_mithril2.default)("div",{class:[CSS_CLASSES.tabRow,opts.centered?CSS_CLASSES.tabRowCentered:null,opts.scrollable?CSS_CLASSES.tabRowIndent:null].join(" "),config:function(el,inited){inited||(ctrl.scrollerEl=el)},onscroll:function(){updateScrollButtons(ctrl)}},[tabRow,tabIndicator]),opts.scrollable?scrollButtonRight:null];return(0,_mithril2.default)(tag,props,[opts.before,content,opts.after])},component={controller:function(){return{tabsEl:null,scrollerEl:null,tabs:[],tabIndicatorEl:null,selectedTabIndex:0,previousOptsSelectedTab:void 0,managesScroll:!1,scrollButtonStates:{left:!1,right:!1}}},view:function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return createView(ctrl,opts)}};exports.default=component,module.exports=exports.default;
//# sourceMappingURL=tabs.js.map