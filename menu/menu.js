"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0});var _events=require("polythene/common/events"),_events2=_interopRequireDefault(_events),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril),_shadow=require("polythene/shadow/shadow"),_shadow2=_interopRequireDefault(_shadow),_transition=require("polythene/common/transition"),_transition2=_interopRequireDefault(_transition);require("polythene/menu/theme/theme");var CSS_CLASSES={block:"pe-menu",content:"pe-menu__content",placeholder:"pe-menu--placeholder",visible:"pe-menu--visible",permanent:"pe-menu--permanent",target:"pe-menu--target",width_n:"pe-menu--width-",width_auto:"pe-menu--width-auto",listTile:"pe-list-tile",selectedListTile:"pe-list-tile--selected"},OFFSET_V=-8,DEFAULT_OFFSET_H=16,MIN_SIZE=1.5,positionMenu=function(ctrl,opts){if("undefined"!=typeof document&&opts.target){var targetEl=document.querySelector("#"+opts.target);if(targetEl){var offsetH=void 0!==opts.offset?opts.offset:DEFAULT_OFFSET_H,menuEl=ctrl.el;if(menuEl){var contentEl=ctrl.contentEl,origin=opts.origin||"top-left",reposition=opts.reposition!==!1,positionOffset=0;if(reposition){var firstItem=contentEl.querySelectorAll("."+CSS_CLASSES.listTile)[0],selectedItem=contentEl.querySelector("."+CSS_CLASSES.selectedListTile);if(firstItem&&selectedItem){var firstItemRect=firstItem.getBoundingClientRect(),selectedItemRect=selectedItem.getBoundingClientRect();positionOffset=selectedItemRect.top-firstItemRect.top}var alignEl=selectedItem||firstItem,alignRect=alignEl.getBoundingClientRect(),_targetRect=targetEl.getBoundingClientRect(),heightDiff=alignRect.height-_targetRect.height;positionOffset+=heightDiff/2}var targetRect=targetEl.getBoundingClientRect(),parentRect=menuEl.parentNode.getBoundingClientRect(),alignLeft=function(){return menuEl.style.left=targetRect.left-parentRect.left+offsetH+"px"},alignRight=function(){return menuEl.style.right=targetRect.right-parentRect.right+offsetH+"px"},alignTop=function(){return menuEl.style.top=targetRect.top-parentRect.top-positionOffset+OFFSET_V+"px"},alignBottom=function(){return menuEl.style.bottom=targetRect.bottom-parentRect.bottom-positionOffset+"px"},alignFn={"top-left":function(){return alignTop()&&alignLeft()},"top-right":function(){return alignTop()&&alignRight()},"bottom-left":function(){return alignBottom()&&alignLeft()},"bottom-right":function(){return alignBottom()&&alignRight()}};alignFn[origin].call()}}}},show=function(ctrl,opts){return ctrl.isTransitioning=!0,_transition2.default.show(Object.assign({},opts,{el:ctrl.el,showClass:CSS_CLASSES.visible})).then(function(){ctrl.isTransitioning=!1,ctrl.visible=!0,opts.didShow&&opts.didShow(opts.id)})},hide=function(ctrl,opts){return ctrl.isTransitioning=!0,_transition2.default.hide(Object.assign({},opts,{el:ctrl.el,showClass:CSS_CLASSES.visible})).then(function(){ctrl.isTransitioning=!1,ctrl.visible=!1,opts.didHide&&opts.didHide(opts.id),_mithril2.default.redraw()})},unifySize=function(size){return size<MIN_SIZE?MIN_SIZE:size},widthClass=function(size){var sizeStr=size.toString().replace(".","-");return CSS_CLASSES.width_n+sizeStr},createView=function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("undefined"!=typeof document){var listenEl=document.body,activateDismissTap=function(){listenEl.addEventListener("click",handleDismissTap)},deActivateDismissTap=function(){listenEl.removeEventListener("click",handleDismissTap)},handleDismissTap=function(e){e.target!==ctrl.el&&(deActivateDismissTap(),e.defaultPrevented?hide(ctrl,opts):hide(ctrl,Object.assign({},opts,{hideDelay:0})))},tag=opts.tag||"div",props={class:[CSS_CLASSES.block,opts.permanent?CSS_CLASSES.permanent:null,opts.target?CSS_CLASSES.target:"layout center-center",opts.size?widthClass(unifySize(opts.size)):null,opts.class].join(" "),id:opts.id||"",config:function(el,inited,context,vdom){if(!inited){opts.config&&opts.config(el,inited,context,vdom),ctrl.el=el;var update=function(){positionMenu(ctrl,opts),_mithril2.default.redraw()},handleEscape=function(e){27===e.which&&hide(ctrl,Object.assign({},opts,{hideDelay:0}))};opts.permanent||(_events2.default.subscribe("resize",update),_events2.default.subscribe("keydown",handleEscape),setTimeout(function(){activateDismissTap(),show(ctrl,opts)},0)),context.onunload=function(){_events2.default.unsubscribe("resize",update),_events2.default.unsubscribe("keydown",handleEscape),opts.permanent||deActivateDismissTap()},positionMenu(ctrl,opts)}}},content=(0,_mithril2.default)("div",{class:CSS_CLASSES.content,config:function(el,inited){inited||(ctrl.contentEl=el)},onclick:function(e){e.preventDefault()}},[_mithril2.default.component(_shadow2.default,{z:ctrl.z,animated:!0}),opts.content?opts.content:null]);return(0,_mithril2.default)(tag,props,[opts.before,content,opts.after])}},component={controller:function(){var opts=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},z=void 0!==opts.z?opts.z:1;return{z:z,el:null,contentEl:null,isTransitioning:!1,visible:opts.permanent||!1}},view:function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return opts.show&&!ctrl.visible&&(ctrl.visible=!0),ctrl.visible?createView(ctrl,opts):(0,_mithril2.default)("span",{class:CSS_CLASSES.placeholder})}};exports.default=component,module.exports=exports.default;
//# sourceMappingURL=menu.js.map