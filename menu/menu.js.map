{"version":3,"sources":["menu.es6"],"names":["_events","require","_mithril","_shadow","_transition","CSS_CLASSES","block","content","placeholder","visible","permanent","target","width_n","width_auto","listTile","selectedListTile","OFFSET_V","DEFAULT_OFFSET_H","MIN_SIZE","positionMenu","ctrl","opts","document","targetEl","querySelector","offsetH","undefined","offset","menuEl","el","contentEl","origin","reposition","positionOffset","firstItem","querySelectorAll","selectedItem","firstItemRect","getBoundingClientRect","selectedItemRect","top","alignEl","alignRect","_targetRect","heightDiff","height","targetRect","parentRect","parentNode","alignLeft","style","left","alignRight","right","alignTop","alignBottom","bottom","alignFn","top-left","top-right","bottom-left","bottom-right","call","show","isTransitioning","_transition2","default","Object","assign","showClass","then","didShow","id","hide","didHide","_mithril2","redraw","unifySize","size","widthClass","sizeStr","toString","replace","createView","arguments","length","listenEl","body","activateDismissTap","addEventListener","handleDismissTap","deActivateDismissTap","removeEventListener","e","defaultPrevented","hideDelay","tag","props","class","join","config","inited","context","vdom","update","handleEscape","which","_events2","subscribe","setTimeout","onunload","unsubscribe","onclick","preventDefault","component","_shadow2","z","animated","before","after","controller","view"],"mappings":"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","file":"menu.js","sourcesContent":["import events from 'polythene/common/events';\nimport m from 'mithril';\nimport shadow from 'polythene/shadow/shadow';\nimport transition from 'polythene/common/transition';\nimport 'polythene/menu/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-menu',\n    content: 'pe-menu__content',\n    placeholder: 'pe-menu--placeholder',\n    visible: 'pe-menu--visible',\n    permanent: 'pe-menu--permanent',\n    target: 'pe-menu--target',\n    width_n: 'pe-menu--width-',\n    width_auto: 'pe-menu--width-auto',\n\n    // lookup\n    listTile: 'pe-list-tile',\n    selectedListTile: 'pe-list-tile--selected'\n};\n\nconst OFFSET_V = -8;\nconst DEFAULT_OFFSET_H = 16;\nconst MIN_SIZE = 1.5;\n\nconst positionMenu = (ctrl, opts) => {\n\tif(typeof document === \"undefined\") {\n\t\treturn;\n\t}\n    if (!opts.target) {\n        return;\n    }\n    const targetEl = document.querySelector('#' + opts.target);\n    if (!targetEl) {\n        return;\n    }\n    const offsetH = (opts.offset !== undefined) ? opts.offset : DEFAULT_OFFSET_H;\n    const menuEl = ctrl.el;\n    if (!menuEl) {\n        return;\n    }\n    const contentEl = ctrl.contentEl;\n    const origin = opts.origin || 'top-left';\n    const reposition = opts.reposition === false ? false : true;\n    let positionOffset = 0;\n    if (reposition) {\n        const firstItem = contentEl.querySelectorAll('.' + CSS_CLASSES.listTile)[0];\n        const selectedItem = contentEl.querySelector('.' + CSS_CLASSES.selectedListTile);\n        if (firstItem && selectedItem) {\n            // calculate v position: menu should shift upward relative to the first item\n            const firstItemRect = firstItem.getBoundingClientRect();\n            const selectedItemRect = selectedItem.getBoundingClientRect();\n            positionOffset = selectedItemRect.top - firstItemRect.top;\n        }\n        // align to middle of target\n        const alignEl = selectedItem || firstItem;\n        const alignRect = alignEl.getBoundingClientRect();\n        const targetRect = targetEl.getBoundingClientRect();\n        const heightDiff = alignRect.height - targetRect.height;\n        positionOffset += heightDiff / 2;\n\n    }\n    const targetRect = targetEl.getBoundingClientRect();\n    const parentRect = menuEl.parentNode.getBoundingClientRect();\n    const alignLeft = () => (menuEl.style.left = targetRect.left - parentRect.left + offsetH + 'px');\n    const alignRight = () => (menuEl.style.right = targetRect.right - parentRect.right + offsetH + 'px');\n    const alignTop = () => (menuEl.style.top = targetRect.top - parentRect.top - positionOffset + OFFSET_V + 'px');\n    const alignBottom = () => (menuEl.style.bottom = targetRect.bottom - parentRect.bottom - positionOffset + 'px');\n    const alignFn = {\n        'top-left': () => (alignTop() && alignLeft()),\n        'top-right': () => (alignTop() && alignRight()),\n        'bottom-left': () => (alignBottom() && alignLeft()),\n        'bottom-right': () => (alignBottom() && alignRight())\n    };\n    alignFn[origin].call();\n};\n\nconst show = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (opts.didShow) {\n            opts.didShow(opts.id);\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (opts.didHide) {\n            opts.didHide(opts.id);\n        }\n        m.redraw(); // removes remainder of drawn component\n    });\n};\n\nconst unifySize = (size) => {\n    return (size < MIN_SIZE) ? MIN_SIZE : size;\n};\n\nconst widthClass = (size) => {\n    const sizeStr = size.toString().replace('.', '-');\n    return CSS_CLASSES.width_n + sizeStr;\n};\n\nconst createView = (ctrl, opts = {}) => {\n\tif(typeof document === \"undefined\") {\n\t\treturn;\n\t}\n    const listenEl = document.body;\n    const activateDismissTap = () => {\n        listenEl.addEventListener('click', handleDismissTap);\n    };\n    const deActivateDismissTap = () => {\n        listenEl.removeEventListener('click', handleDismissTap);\n    };\n    const handleDismissTap = (e) => {\n        if (e.target === ctrl.el) {\n            return;\n        }\n        deActivateDismissTap();\n        if (e.defaultPrevented) {\n            // clicked on .pe-menu__content\n            hide(ctrl, opts);\n        } else {\n            hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n        }\n    };\n    const tag = opts.tag || 'div';\n    const props = {\n        class: [CSS_CLASSES.block, (opts.permanent ? CSS_CLASSES.permanent : null), (opts.target ? CSS_CLASSES.target : 'layout center-center'), (opts.size ? widthClass(unifySize(opts.size)) : null), opts.class].join(' '),\n\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const update = () => {\n                positionMenu(ctrl, opts);\n                m.redraw();\n            };\n\n            const handleEscape = (e) => {\n                if (e.which === 27) {\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            if (!opts.permanent) {\n                events.subscribe('resize', update);\n                events.subscribe('keydown', handleEscape);\n                setTimeout(() => {\n                    activateDismissTap();\n                    show(ctrl, opts);\n                }, 0);\n            }\n            context.onunload = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n                if (!opts.permanent) {\n                    deActivateDismissTap();\n                }\n            };\n\n            positionMenu(ctrl, opts);\n        }\n    };\n    const content = m('div', {\n        class: CSS_CLASSES.content,\n        config: (el, inited) => {\n            if (!inited) {\n                ctrl.contentEl = el;\n            }\n        },\n        onclick: (e) => {\n            e.preventDefault();\n        }\n    }, [\n        m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.content ? opts.content : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (opts = {}) => {\n        let z = (opts.z !== undefined) ? opts.z : 1;\n        return {\n            z: z,\n            el: null,\n            contentEl: null,\n            isTransitioning: false,\n            visible: opts.permanent || false\n        };\n    },\n    view: (ctrl, opts = {}) => {\n        if (opts.show && !ctrl.visible) {\n            ctrl.visible = true;\n        }\n        if (ctrl.visible) {\n            return createView(ctrl, opts);\n        } else {\n            return m('span', {class: CSS_CLASSES.placeholder});\n        }\n    }\n};\n\nexport default component;\n"]}