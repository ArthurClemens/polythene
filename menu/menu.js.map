{"version":3,"sources":["menu.es6"],"names":["_events","require","_mithril","_shadow","_transition","_isomorphic","CSS_CLASSES","block","content","placeholder","visible","permanent","target","width_n","width_auto","listTile","selectedListTile","OFFSET_V","DEFAULT_OFFSET_H","MIN_SIZE","positionMenu","ctrl","opts","_isomorphic2","default","isServer","targetEl","document","querySelector","offsetH","undefined","offset","menuEl","el","contentEl","origin","reposition","positionOffset","firstItem","querySelectorAll","selectedItem","firstItemRect","getBoundingClientRect","selectedItemRect","top","alignEl","alignRect","_targetRect","heightDiff","height","targetRect","parentRect","parentNode","alignLeft","style","left","alignRight","right","alignTop","alignBottom","bottom","alignFn","top-left","top-right","bottom-left","bottom-right","call","show","isTransitioning","_transition2","Object","assign","showClass","then","didShow","id","hide","didHide","_mithril2","redraw","unifySize","size","widthClass","sizeStr","toString","replace","createView","arguments","length","listenEl","body","activateDismissTap","addEventListener","handleDismissTap","deActivateDismissTap","removeEventListener","e","defaultPrevented","hideDelay","tag","props","class","join","config","inited","context","vdom","update","handleEscape","which","_events2","subscribe","setTimeout","onunload","unsubscribe","onclick","preventDefault","component","_shadow2","z","animated","before","after","controller","view"],"mappings":"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","file":"menu.js","sourcesContent":["import events from 'polythene/common/events';\nimport m from 'mithril';\nimport shadow from 'polythene/shadow/shadow';\nimport transition from 'polythene/common/transition';\nimport isomorphic from 'polythene/common/isomorphic';\nimport 'polythene/menu/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-menu',\n    content: 'pe-menu__content',\n    placeholder: 'pe-menu--placeholder',\n    visible: 'pe-menu--visible',\n    permanent: 'pe-menu--permanent',\n    target: 'pe-menu--target',\n    width_n: 'pe-menu--width-',\n    width_auto: 'pe-menu--width-auto',\n\n    // lookup\n    listTile: 'pe-list-tile',\n    selectedListTile: 'pe-list-tile--selected'\n};\n\nconst OFFSET_V = -8;\nconst DEFAULT_OFFSET_H = 16;\nconst MIN_SIZE = 1.5;\n\nconst positionMenu = (ctrl, opts) => {\n\tif(isomorphic.isServer()) {\n\t\treturn;\n\t}\n    if (!opts.target) {\n        return;\n    }\n    const targetEl = document.querySelector('#' + opts.target);\n    if (!targetEl) {\n        return;\n    }\n    const offsetH = (opts.offset !== undefined) ? opts.offset : DEFAULT_OFFSET_H;\n    const menuEl = ctrl.el;\n    if (!menuEl) {\n        return;\n    }\n    const contentEl = ctrl.contentEl;\n    const origin = opts.origin || 'top-left';\n    const reposition = opts.reposition === false ? false : true;\n    let positionOffset = 0;\n    if (reposition) {\n        const firstItem = contentEl.querySelectorAll('.' + CSS_CLASSES.listTile)[0];\n        const selectedItem = contentEl.querySelector('.' + CSS_CLASSES.selectedListTile);\n        if (firstItem && selectedItem) {\n            // calculate v position: menu should shift upward relative to the first item\n            const firstItemRect = firstItem.getBoundingClientRect();\n            const selectedItemRect = selectedItem.getBoundingClientRect();\n            positionOffset = selectedItemRect.top - firstItemRect.top;\n        }\n        // align to middle of target\n        const alignEl = selectedItem || firstItem;\n        const alignRect = alignEl.getBoundingClientRect();\n        const targetRect = targetEl.getBoundingClientRect();\n        const heightDiff = alignRect.height - targetRect.height;\n        positionOffset += heightDiff / 2;\n\n    }\n    const targetRect = targetEl.getBoundingClientRect();\n    const parentRect = menuEl.parentNode.getBoundingClientRect();\n    const alignLeft = () => (menuEl.style.left = targetRect.left - parentRect.left + offsetH + 'px');\n    const alignRight = () => (menuEl.style.right = targetRect.right - parentRect.right + offsetH + 'px');\n    const alignTop = () => (menuEl.style.top = targetRect.top - parentRect.top - positionOffset + OFFSET_V + 'px');\n    const alignBottom = () => (menuEl.style.bottom = targetRect.bottom - parentRect.bottom - positionOffset + 'px');\n    const alignFn = {\n        'top-left': () => (alignTop() && alignLeft()),\n        'top-right': () => (alignTop() && alignRight()),\n        'bottom-left': () => (alignBottom() && alignLeft()),\n        'bottom-right': () => (alignBottom() && alignRight())\n    };\n    alignFn[origin].call();\n};\n\nconst show = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (opts.didShow) {\n            opts.didShow(opts.id);\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (opts.didHide) {\n            opts.didHide(opts.id);\n        }\n        m.redraw(); // removes remainder of drawn component\n    });\n};\n\nconst unifySize = (size) => {\n    return (size < MIN_SIZE) ? MIN_SIZE : size;\n};\n\nconst widthClass = (size) => {\n    const sizeStr = size.toString().replace('.', '-');\n    return CSS_CLASSES.width_n + sizeStr;\n};\n\nconst createView = (ctrl, opts = {}) => {\n\tif(isomorphic.isServer()) {\n\t\treturn;\n\t}\n    const listenEl = document.body;\n    const activateDismissTap = () => {\n        listenEl.addEventListener('click', handleDismissTap);\n    };\n    const deActivateDismissTap = () => {\n        listenEl.removeEventListener('click', handleDismissTap);\n    };\n    const handleDismissTap = (e) => {\n        if (e.target === ctrl.el) {\n            return;\n        }\n        deActivateDismissTap();\n        if (e.defaultPrevented) {\n            // clicked on .pe-menu__content\n            hide(ctrl, opts);\n        } else {\n            hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n        }\n    };\n    const tag = opts.tag || 'div';\n    const props = {\n        class: [CSS_CLASSES.block, (opts.permanent ? CSS_CLASSES.permanent : null), (opts.target ? CSS_CLASSES.target : 'layout center-center'), (opts.size ? widthClass(unifySize(opts.size)) : null), opts.class].join(' '),\n\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const update = () => {\n                positionMenu(ctrl, opts);\n                m.redraw();\n            };\n\n            const handleEscape = (e) => {\n                if (e.which === 27) {\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            if (!opts.permanent) {\n                events.subscribe('resize', update);\n                events.subscribe('keydown', handleEscape);\n                setTimeout(() => {\n                    activateDismissTap();\n                    show(ctrl, opts);\n                }, 0);\n            }\n            context.onunload = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n                if (!opts.permanent) {\n                    deActivateDismissTap();\n                }\n            };\n\n            positionMenu(ctrl, opts);\n        }\n    };\n    const content = m('div', {\n        class: CSS_CLASSES.content,\n        config: (el, inited) => {\n            if (!inited) {\n                ctrl.contentEl = el;\n            }\n        },\n        onclick: (e) => {\n            e.preventDefault();\n        }\n    }, [\n        m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.content ? opts.content : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (opts = {}) => {\n        let z = (opts.z !== undefined) ? opts.z : 1;\n        return {\n            z: z,\n            el: null,\n            contentEl: null,\n            isTransitioning: false,\n            visible: opts.permanent || false\n        };\n    },\n    view: (ctrl, opts = {}) => {\n        if (opts.show && !ctrl.visible) {\n            ctrl.visible = true;\n        }\n        if (ctrl.visible) {\n            return createView(ctrl, opts);\n        } else {\n            return m('span', {class: CSS_CLASSES.placeholder});\n        }\n    }\n};\n\nexport default component;\n"]}