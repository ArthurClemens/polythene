{"version":3,"sources":["menu.es6"],"names":["CSS_CLASSES","block","content","placeholder","visible","permanent","target","width_n","width_auto","listTile","selectedListTile","OFFSET_V","DEFAULT_OFFSET_H","MIN_SIZE","positionMenu","isServer","opts","document","querySelector","targetEl","offset","ctrl","el","menuEl","contentEl","origin","reposition","querySelectorAll","firstItem","selectedItem","getBoundingClientRect","selectedItemRect","top","firstItemRect","alignRect","height","targetRect","heightDiff","parentNode","alignLeft","style","left","parentRect","offsetH","alignRight","right","alignTop","positionOffset","alignBottom","bottom","call","show","isTransitioning","Object","assign","showClass","then","didShow","id","hide","didHide","redraw","unifySize","size","widthClass","toString","replace","sizeStr","createView","body","activateDismissTap","listenEl","addEventListener","handleDismissTap","deActivateDismissTap","removeEventListener","e","defaultPrevented","hideDelay","tag","class","join","config","inited","context","vdom","update","handleEscape","which","subscribe","setTimeout","onunload","unsubscribe","preventDefault","component","z","animated","props","before","after","controller","view"],"mappings":"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","file":"menu.js","sourcesContent":["import events from 'polythene/common/events';\nimport m from 'mithril';\nimport shadow from 'polythene/shadow/shadow';\nimport transition from 'polythene/common/transition';\nimport isomorphic from 'polythene/common/isomorphic';\nimport 'polythene/menu/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-menu',\n    content: 'pe-menu__content',\n    placeholder: 'pe-menu--placeholder',\n    visible: 'pe-menu--visible',\n    permanent: 'pe-menu--permanent',\n    target: 'pe-menu--target',\n    width_n: 'pe-menu--width-',\n    width_auto: 'pe-menu--width-auto',\n\n    // lookup\n    listTile: 'pe-list-tile',\n    selectedListTile: 'pe-list-tile--selected'\n};\n\nconst OFFSET_V = -8;\nconst DEFAULT_OFFSET_H = 16;\nconst MIN_SIZE = 1.5;\n\nconst positionMenu = (ctrl, opts) => {\n\tif(isomorphic.isServer()) {\n\t\treturn;\n\t}\n    if (!opts.target) {\n        return;\n    }\n    const targetEl = document.querySelector('#' + opts.target);\n    if (!targetEl) {\n        return;\n    }\n    const offsetH = (opts.offset !== undefined) ? opts.offset : DEFAULT_OFFSET_H;\n    const menuEl = ctrl.el;\n    if (!menuEl) {\n        return;\n    }\n    const contentEl = ctrl.contentEl;\n    const origin = opts.origin || 'top-left';\n    const reposition = opts.reposition === false ? false : true;\n    let positionOffset = 0;\n    if (reposition) {\n        const firstItem = contentEl.querySelectorAll('.' + CSS_CLASSES.listTile)[0];\n        const selectedItem = contentEl.querySelector('.' + CSS_CLASSES.selectedListTile);\n        if (firstItem && selectedItem) {\n            // calculate v position: menu should shift upward relative to the first item\n            const firstItemRect = firstItem.getBoundingClientRect();\n            const selectedItemRect = selectedItem.getBoundingClientRect();\n            positionOffset = selectedItemRect.top - firstItemRect.top;\n        }\n        // align to middle of target\n        const alignEl = selectedItem || firstItem;\n        const alignRect = alignEl.getBoundingClientRect();\n        const targetRect = targetEl.getBoundingClientRect();\n        const heightDiff = alignRect.height - targetRect.height;\n        positionOffset += heightDiff / 2;\n\n    }\n    const targetRect = targetEl.getBoundingClientRect();\n    const parentRect = menuEl.parentNode.getBoundingClientRect();\n    const alignLeft = () => (menuEl.style.left = targetRect.left - parentRect.left + offsetH + 'px');\n    const alignRight = () => (menuEl.style.right = targetRect.right - parentRect.right + offsetH + 'px');\n    const alignTop = () => (menuEl.style.top = targetRect.top - parentRect.top - positionOffset + OFFSET_V + 'px');\n    const alignBottom = () => (menuEl.style.bottom = targetRect.bottom - parentRect.bottom - positionOffset + 'px');\n    const alignFn = {\n        'top-left': () => (alignTop() && alignLeft()),\n        'top-right': () => (alignTop() && alignRight()),\n        'bottom-left': () => (alignBottom() && alignLeft()),\n        'bottom-right': () => (alignBottom() && alignRight())\n    };\n    alignFn[origin].call();\n};\n\nconst show = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (opts.didShow) {\n            opts.didShow(opts.id);\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign(\n        {},\n        opts, {\n            el: ctrl.el,\n            showClass: CSS_CLASSES.visible\n        }\n    )).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (opts.didHide) {\n            opts.didHide(opts.id);\n        }\n        m.redraw(); // removes remainder of drawn component\n    });\n};\n\nconst unifySize = (size) => {\n    return (size < MIN_SIZE) ? MIN_SIZE : size;\n};\n\nconst widthClass = (size) => {\n    const sizeStr = size.toString().replace('.', '-');\n    return CSS_CLASSES.width_n + sizeStr;\n};\n\nconst createView = (ctrl, opts = {}) => {\n\tif(isomorphic.isServer()) {\n\t\treturn;\n\t}\n    const listenEl = document.body;\n    const activateDismissTap = () => {\n        listenEl.addEventListener('click', handleDismissTap);\n    };\n    const deActivateDismissTap = () => {\n        listenEl.removeEventListener('click', handleDismissTap);\n    };\n    const handleDismissTap = (e) => {\n        if (e.target === ctrl.el) {\n            return;\n        }\n        deActivateDismissTap();\n        if (e.defaultPrevented) {\n            // clicked on .pe-menu__content\n            hide(ctrl, opts);\n        } else {\n            hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n        }\n    };\n    const tag = opts.tag || 'div';\n    const props = {\n        class: [\n            CSS_CLASSES.block,\n            opts.permanent ? CSS_CLASSES.permanent : null,\n            opts.target ? CSS_CLASSES.target : 'layout center-center',\n            opts.size ? widthClass(unifySize(opts.size)) : null,\n            opts.class\n        ].join(' '),\n\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const update = () => {\n                positionMenu(ctrl, opts);\n                m.redraw();\n            };\n\n            const handleEscape = (e) => {\n                if (e.which === 27) {\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            if (!opts.permanent) {\n                events.subscribe('resize', update);\n                events.subscribe('keydown', handleEscape);\n                setTimeout(() => {\n                    activateDismissTap();\n                    show(ctrl, opts);\n                }, 0);\n            }\n            context.onunload = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n                if (!opts.permanent) {\n                    deActivateDismissTap();\n                }\n            };\n\n            positionMenu(ctrl, opts);\n        }\n    };\n    const content = m('div', {\n        class: CSS_CLASSES.content,\n        config: (el, inited) => {\n            if (!inited) {\n                ctrl.contentEl = el;\n            }\n        },\n        onclick: (e) => {\n            e.preventDefault();\n        }\n    }, [\n        m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.content ? opts.content : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (opts = {}) => {\n        let z = (opts.z !== undefined) ? opts.z : 1;\n        return {\n            z: z,\n            el: null,\n            contentEl: null,\n            isTransitioning: false,\n            visible: opts.permanent || false\n        };\n    },\n    view: (ctrl, opts = {}) => {\n        if (opts.show && !ctrl.visible) {\n            ctrl.visible = true;\n        }\n        if (ctrl.visible) {\n            return createView(ctrl, opts);\n        } else {\n            return m('span', {class: CSS_CLASSES.placeholder});\n        }\n    }\n};\n\nexport default component;\n"]}