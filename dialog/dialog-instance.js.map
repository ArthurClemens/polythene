{"version":3,"sources":["dialog-instance.es6"],"names":["CSS_CLASSES","block","visible","body","fullscreen","content","header","footer","footerHigh","title","actions","hasBackdrop","hasTopOverflow","hasBottomOverflow","menuContent","SCROLL_WATCH_TIMER","updateScrollState","ctrl","scrollEl","scroller","topOverflow","scrollTop","bottomOverflow","scrollHeight","getBoundingClientRect","height","updateFooterState","isServer","footerEl","window","getComputedStyle","parseInt","style","minHeight","classList","add","remove","show","instanceId","isTransitioning","Object","assign","opts","el","showClass","then","didShow","id","hide","didHide","setTimeout","redraw","createViewContent","menu","inited","isScrolling","clearTimeout","scrollWatchId","bodyOpts","createView","updateContentOnScroll","tag","update","class","backdrop","borders","join","config","context","vdom","cleanup","unsubscribe","handleEscape","modal","which","hideDelay","subscribe","onunload","onclick","e","target","formOptions","ignoreContent","subtree","component","z","animated","headerHeight","footerHeight","props","before","after","controller","instanceData","view"],"mappings":"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","file":"dialog-instance.js","sourcesContent":["import 'polythene/common/object.assign';\nimport events from 'polythene/common/events';\nimport m from 'mithril';\nimport dialog from 'polythene/dialog/dialog';\nimport transition from 'polythene/common/transition';\nimport shadow from 'polythene/shadow/shadow';\nimport isomorphic from 'polythene/common/isomorphic';\nimport 'polythene/dialog/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-dialog',\n    visible: 'pe-dialog--visible',\n    body: 'pe-dialog__body',\n    fullscreen: 'pe-dialog--fullscreen',\n    content: 'pe-dialog__content',\n    header: 'pe-dialog__header',\n    footer: 'pe-dialog__footer',\n    footerHigh: 'pe-dialog__footer--high',\n    title: 'pe-dialog__title',\n    actions: 'pe-dialog__actions',\n    hasBackdrop: 'pe-dialog--backdrop',\n    hasTopOverflow: 'pe-dialog--overflow-top',\n    hasBottomOverflow: 'pe-dialog--overflow-bottom',\n    menuContent: 'pe-menu__content'\n};\n\nconst SCROLL_WATCH_TIMER = 150;\n\nconst updateScrollState = (ctrl) => {\n    const scroller = ctrl.scrollEl;\n    if (!scroller) {\n        return;\n    }\n    ctrl.topOverflow = (scroller.scrollTop > 0);\n    ctrl.bottomOverflow = (scroller.scrollHeight - (scroller.scrollTop + scroller.getBoundingClientRect().height) > 0);\n};\n\nconst updateFooterState = (ctrl) => {\n\tif(isomorphic.isServer()) {\n\t\treturn;\n\t}\n    const footerEl = ctrl.footerEl;\n    if (footerEl) {\n        const style = window.getComputedStyle(footerEl);\n        const height = footerEl.getBoundingClientRect().height;\n        const minHeight = parseInt(style.minHeight, 10);\n        if (height > minHeight) {\n            footerEl.classList.add(CSS_CLASSES.footerHigh);\n        } else {\n            footerEl.classList.remove(CSS_CLASSES.footerHigh);\n        }\n    }\n};\n\nconst show = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (ctrl.didShow) {\n            // notify multiple\n            ctrl.didShow(id);\n            // this will call opts.didShow\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        dialog.remove(id);\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (ctrl.didHide) {\n            // notify multiple\n            ctrl.didHide(id);\n            // this will call opts.didHide\n        }\n        setTimeout(m.redraw, 0); // removes remainder of drawn component\n    });\n};\n\nconst createViewContent = (ctrl, opts) => {\n    // if flex \"self-stretch\" is not supported, calculate the maximum height\n    let style = {};\n    const bodyOpts = opts.body || opts.menu;\n\n    return m('div', {\n        class: CSS_CLASSES.body,\n        style: style,\n        config: (el, inited) => {\n            if (inited) {\n                return;\n            }\n            ctrl.scrollEl = el;\n        },\n        onscroll: () => {\n            ctrl.isScrolling = true;\n            updateScrollState(ctrl);\n\n            clearTimeout(ctrl.scrollWatchId);\n            ctrl.scrollWatchId = setTimeout(() => {\n                ctrl.isScrolling = false;\n            }, SCROLL_WATCH_TIMER);\n        }\n    }, bodyOpts);\n};\n\nconst createView = (ctrl, opts = {}) => {\n    const bodyOpts = opts.body || opts.menu;\n    const updateContentOnScroll = opts.updateContentOnScroll || false;\n    const ignoreContent = !updateContentOnScroll && ctrl.isScrolling;\n    const tag = opts.tag || 'form';\n\n    const update = () => {\n        updateScrollState(ctrl);\n        updateFooterState(ctrl);\n        m.redraw();\n    };\n\n    const props = Object.assign({}, {\n        class: [\n            CSS_CLASSES.block,\n            (opts.fullscreen ? CSS_CLASSES.fullscreen : null),\n            (opts.backdrop ? CSS_CLASSES.hasBackdrop : null),\n            (ctrl.topOverflow || opts.borders ? CSS_CLASSES.hasTopOverflow : null),\n            (ctrl.bottomOverflow || opts.borders ? CSS_CLASSES.hasBottomOverflow : null),\n            ctrl.visible ? CSS_CLASSES.visible : null,\n            opts.class\n        ].join(' '),\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const cleanup = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n            };\n\n            const handleEscape = (e) => {\n                if (opts.fullscreen || opts.modal) return;\n                if (e.which === 27) {\n                    cleanup();\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            // resize: update scroll state ('overflow' borders)\n            events.subscribe('resize', update);\n            events.subscribe('keydown', handleEscape);\n\n            context.onunload = () => {\n                cleanup();\n            };\n\n            updateScrollState(ctrl);\n            updateFooterState(ctrl);\n\n            show(ctrl, opts).then(() => {\n                updateScrollState(ctrl);\n                updateFooterState(ctrl);\n                if (ctrl.topOverflow || ctrl.bottomOverflow) {\n                    setTimeout(m.redraw, 0);\n                }\n            });\n        },\n        // click backdrop: close dialog\n        onclick: (e) => {\n            if (e.target !== ctrl.el) {\n                return;\n            }\n            if (opts.modal) {\n                // not allowed\n                return;\n            }\n            if (!ctrl.isTransitioning) {\n                hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n            }\n        }\n    }, opts.formOptions ? opts.formOptions : null);\n\n    const body = bodyOpts ? (ignoreContent ? {\n        subtree: 'retain'\n    } : createViewContent(ctrl, opts)) : null;\n\n    const content = m('div', {\n        class: [CSS_CLASSES.content, (opts.menu ? CSS_CLASSES.menuContent : null)].join(' ')\n    }, [\n        opts.fullscreen ? null : m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.fullscreen ? null : opts.title ? m('div', {\n            class: CSS_CLASSES.header,\n            config: (el) => {\n                ctrl.headerHeight = el.scrollHeight;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.title}, opts.title)\n        ]) : null,\n        body,\n        opts.fullscreen ? null : opts.footer ? m('div', {\n            class: CSS_CLASSES.footer,\n            config: (el, inited) => {\n                ctrl.footerHeight = el.scrollHeight;\n                if (inited) {\n                    return;\n                }\n                ctrl.footerEl = el;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.actions}, opts.footer)\n        ]) : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (instanceData = {}) => {\n        // instanceData contains {id, opts}\n        const opts = instanceData.opts || {};\n        let z = (opts.z !== undefined) ? opts.z : 3; // shadow depth\n        return Object.assign({}, instanceData, {\n            instanceId: instanceData.instanceId,\n            z: z,\n            scrollEl: null,\n            footerEl: null,\n            topOverflow: false,\n            bottomOverflow: false,\n            scrollWatchId: 0,\n            isScrolling: false,\n            headerHeight: 0,\n            footerHeight: 0,\n            el: null,\n            visible: false,\n            isTransitioning: false\n        });\n    },\n    view: (ctrl, instanceData) => {\n        // instanceData contains {id, opts}\n        const opts = (typeof instanceData.opts === 'function')\n            ? instanceData.opts()\n            : instanceData.opts;\n        if (instanceData.hide && !ctrl.isTransitioning) {\n            hide(ctrl, opts);\n        }\n        return createView(ctrl, opts);\n    }\n};\n\nexport default component;\n"]}