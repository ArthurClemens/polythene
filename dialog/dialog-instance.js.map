{"version":3,"sources":["dialog-instance.es6"],"names":["require","_events","_mithril","_dialog","_transition","_shadow","CSS_CLASSES","block","visible","body","fullscreen","content","header","footer","footerHigh","title","actions","hasBackdrop","hasTopOverflow","hasBottomOverflow","menuContent","SCROLL_WATCH_TIMER","updateScrollState","ctrl","scroller","scrollEl","topOverflow","scrollTop","bottomOverflow","scrollHeight","getBoundingClientRect","height","updateFooterState","footerEl","style","window","getComputedStyle","minHeight","parseInt","classList","add","remove","show","opts","id","instanceId","isTransitioning","_transition2","default","Object","assign","el","showClass","then","didShow","hide","_dialog2","didHide","setTimeout","_mithril2","redraw","createViewContent","bodyOpts","menu","class","config","inited","onscroll","isScrolling","clearTimeout","scrollWatchId","createView","arguments","length","undefined","updateContentOnScroll","ignoreContent","tag","update","props","backdrop","borders","join","context","vdom","cleanup","_events2","unsubscribe","handleEscape","e","which","hideDelay","subscribe","onunload","onclick","target","modal","formOptions","subtree","component","_shadow2","z","animated","headerHeight","footerHeight","before","after","controller","instanceData","view"],"mappings":"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","file":"dialog-instance.js","sourcesContent":["import 'polythene/common/object.assign';\nimport events from 'polythene/common/events';\nimport m from 'mithril';\nimport dialog from 'polythene/dialog/dialog';\nimport transition from 'polythene/common/transition';\nimport shadow from 'polythene/shadow/shadow';\nimport 'polythene/dialog/theme/theme';\n\nconst CSS_CLASSES = {\n    block: 'pe-dialog',\n    visible: 'pe-dialog--visible',\n    body: 'pe-dialog__body',\n    fullscreen: 'pe-dialog--fullscreen',\n    content: 'pe-dialog__content',\n    header: 'pe-dialog__header',\n    footer: 'pe-dialog__footer',\n    footerHigh: 'pe-dialog__footer--high',\n    title: 'pe-dialog__title',\n    actions: 'pe-dialog__actions',\n    hasBackdrop: 'pe-dialog--backdrop',\n    hasTopOverflow: 'pe-dialog--overflow-top',\n    hasBottomOverflow: 'pe-dialog--overflow-bottom',\n    menuContent: 'pe-menu__content'\n};\n\nconst SCROLL_WATCH_TIMER = 150;\n\nconst updateScrollState = (ctrl) => {\n    const scroller = ctrl.scrollEl;\n    if (!scroller) {\n        return;\n    }\n    ctrl.topOverflow = (scroller.scrollTop > 0);\n    ctrl.bottomOverflow = (scroller.scrollHeight - (scroller.scrollTop + scroller.getBoundingClientRect().height) > 0);\n};\n\nconst updateFooterState = (ctrl) => {\n    const footerEl = ctrl.footerEl;\n    if (footerEl) {\n        const style = window.getComputedStyle(footerEl);\n        const height = footerEl.getBoundingClientRect().height;\n        const minHeight = parseInt(style.minHeight, 10);\n        if (height > minHeight) {\n            footerEl.classList.add(CSS_CLASSES.footerHigh);\n        } else {\n            footerEl.classList.remove(CSS_CLASSES.footerHigh);\n        }\n    }\n};\n\nconst show = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.show(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        ctrl.isTransitioning = false;\n        ctrl.visible = true;\n        if (ctrl.didShow) {\n            // notify multiple\n            ctrl.didShow(id);\n            // this will call opts.didShow\n        }\n    });\n};\n\nconst hide = (ctrl, opts) => {\n    const id = ctrl.instanceId;\n    ctrl.isTransitioning = true;\n    return transition.hide(Object.assign({}, opts, {\n        el: ctrl.el,\n        showClass: CSS_CLASSES.visible\n    })).then(() => {\n        dialog.remove(id);\n        ctrl.isTransitioning = false;\n        ctrl.visible = false;\n        if (ctrl.didHide) {\n            // notify multiple\n            ctrl.didHide(id);\n            // this will call opts.didHide\n        }\n        setTimeout(m.redraw, 0); // removes remainder of drawn component\n    });\n};\n\nconst createViewContent = (ctrl, opts) => {\n    // if flex \"self-stretch\" is not supported, calculate the maximum height\n    let style = {};\n    const bodyOpts = opts.body || opts.menu;\n\n    return m('div', {\n        class: CSS_CLASSES.body,\n        style: style,\n        config: (el, inited) => {\n            if (inited) {\n                return;\n            }\n            ctrl.scrollEl = el;\n        },\n        onscroll: () => {\n            ctrl.isScrolling = true;\n            updateScrollState(ctrl);\n\n            clearTimeout(ctrl.scrollWatchId);\n            ctrl.scrollWatchId = setTimeout(() => {\n                ctrl.isScrolling = false;\n            }, SCROLL_WATCH_TIMER);\n        }\n    }, bodyOpts);\n};\n\nconst createView = (ctrl, opts = {}) => {\n    const bodyOpts = opts.body || opts.menu;\n    const updateContentOnScroll = opts.updateContentOnScroll || false;\n    const ignoreContent = !updateContentOnScroll && ctrl.isScrolling;\n    const tag = opts.tag || 'form';\n\n    const update = () => {\n        updateScrollState(ctrl);\n        updateFooterState(ctrl);\n        m.redraw();\n    };\n\n    const props = Object.assign({}, {\n        class: [\n            CSS_CLASSES.block,\n            (opts.fullscreen ? CSS_CLASSES.fullscreen : null),\n            (opts.backdrop ? CSS_CLASSES.hasBackdrop : null),\n            (ctrl.topOverflow || opts.borders ? CSS_CLASSES.hasTopOverflow : null),\n            (ctrl.bottomOverflow || opts.borders ? CSS_CLASSES.hasBottomOverflow : null),\n            ctrl.visible ? CSS_CLASSES.visible : null,\n            opts.class\n        ].join(' '),\n        id: opts.id || '',\n        config: (el, inited, context, vdom) => {\n            if (inited) {\n                return;\n            }\n            if (opts.config) {\n                opts.config(el, inited, context, vdom);\n            }\n            ctrl.el = el;\n\n            const cleanup = () => {\n                events.unsubscribe('resize', update);\n                events.unsubscribe('keydown', handleEscape);\n            };\n\n            const handleEscape = (e) => {\n                if (opts.fullscreen || opts.backdrop) return;\n                if (e.which === 27) {\n                    cleanup();\n                    hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n                }\n            };\n\n            // resize: update scroll state ('overflow' borders)\n            events.subscribe('resize', update);\n            events.subscribe('keydown', handleEscape);\n\n            context.onunload = () => {\n                cleanup();\n            };\n\n            updateScrollState(ctrl);\n            updateFooterState(ctrl);\n\n            show(ctrl, opts).then(() => {\n                updateScrollState(ctrl);\n                updateFooterState(ctrl);\n                if (ctrl.topOverflow || ctrl.bottomOverflow) {\n                    setTimeout(m.redraw, 0);\n                }\n            });\n        },\n        // click backdrop: close dialog\n        onclick: (e) => {\n            if (e.target !== ctrl.el) {\n                return;\n            }\n            if (opts.modal) {\n                // not allowed\n                return;\n            }\n            if (!ctrl.isTransitioning) {\n                hide(ctrl, Object.assign({}, opts, {hideDelay: 0}));\n            }\n        }\n    }, opts.formOptions ? opts.formOptions : null);\n\n    const body = bodyOpts ? (ignoreContent ? {\n        subtree: 'retain'\n    } : createViewContent(ctrl, opts)) : null;\n\n    const content = m('div', {\n        class: [CSS_CLASSES.content, (opts.menu ? CSS_CLASSES.menuContent : null)].join(' ')\n    }, [\n        opts.fullscreen ? null : m.component(shadow, {\n            z: ctrl.z,\n            animated: true\n        }),\n        opts.fullscreen ? null : opts.title ? m('div', {\n            class: CSS_CLASSES.header,\n            config: (el) => {\n                ctrl.headerHeight = el.scrollHeight;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.title}, opts.title)\n        ]) : null,\n        body,\n        opts.fullscreen ? null : opts.footer ? m('div', {\n            class: CSS_CLASSES.footer,\n            config: (el, inited) => {\n                ctrl.footerHeight = el.scrollHeight;\n                if (inited) {\n                    return;\n                }\n                ctrl.footerEl = el;\n            }\n        }, [\n            m('div', {class: CSS_CLASSES.actions}, opts.footer)\n        ]) : null\n    ]);\n    return m(tag, props, [opts.before, content, opts.after]);\n};\n\nconst component = {\n    controller: (instanceData = {}) => {\n        // instanceData contains {id, opts}\n        const opts = instanceData.opts || {};\n        let z = (opts.z !== undefined) ? opts.z : 3; // shadow depth\n        return Object.assign({}, instanceData, {\n            instanceId: instanceData.instanceId,\n            z: z,\n            scrollEl: null,\n            footerEl: null,\n            topOverflow: false,\n            bottomOverflow: false,\n            scrollWatchId: 0,\n            isScrolling: false,\n            headerHeight: 0,\n            footerHeight: 0,\n            el: null,\n            visible: instanceData.show ? true : false,\n            isTransitioning: false\n        });\n    },\n    view: (ctrl, instanceData) => {\n        // instanceData contains {id, opts}\n        const opts = (typeof instanceData.opts === 'function')\n            ? instanceData.opts()\n            : instanceData.opts;\n        if (instanceData.hide && !ctrl.isTransitioning) {\n            hide(ctrl, opts);\n        }\n        return createView(ctrl, opts);\n    }\n};\n\nexport default component;\n"]}