"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}require("polythene/common/object.assign");var _polythenePolythenePolythene=require("polythene/polythene/polythene");var _polythenePolythenePolythene2=_interopRequireDefault(_polythenePolythenePolythene);var _mithril=require("mithril");var _mithril2=_interopRequireDefault(_mithril);var _polytheneToolbarToolbar=require("polythene/toolbar/toolbar");var _polytheneToolbarToolbar2=_interopRequireDefault(_polytheneToolbarToolbar);require("polythene-theme/header-panel/header-panel");var DEFAULT_SHADOW_HEIGTH=6;var DEFAULT_HEADER_HEIGHT=192;var DEFAULT_CONDENSED_HEADER_HEIGHT=DEFAULT_HEADER_HEIGHT/3;var SCROLL_WATCH_TIMER=150;var scroller=undefined;var modeConfigs={shadowAfterScroll:{waterfall:1,"waterfall-tall":1},alwaysShadow:{standard:1,tall:1},noShadow:{seamed:1,cover:1,scroll:1},tallMode:{tall:true,"waterfall-tall":true},outerScroll:{scroll:1}};var setTransform=document.documentElement.style.transform!==undefined?function(style,string){style.transform=string}:function(style,string){style.webkitTransform=string};var translateY=function translateY(s,y){var t=y===null?"":"translate3d(0, "+y+"px, 0)";setTransform(s,t)};var createHeaderComponent=function createHeaderComponent(){var opts=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var tall=opts.tall||false;var tallClass=opts.tallClass||"";if(opts.toolbar){opts.toolbar["class"]=[opts.toolbar["class"]||null,tall?tallClass:null].join(" ");return _mithril2["default"].component(_polytheneToolbarToolbar2["default"],opts.toolbar)}else if(opts.content){return(0,_mithril2["default"])([".header",opts.animated?" .animate":""].join(" "),{"class":[opts["class"]||null,tall?tallClass:null].join(" ")},opts.content)}else{return(0,_mithril2["default"])("div",opts)}};var createViewHeader=function createViewHeader(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var initHeaderContainer=function initHeaderContainer(headerContainer,inited){if(inited){return}ctrl.headerContainerElem=headerContainer};var header=opts.header?createHeaderComponent(Object.assign({},opts.header,ctrl.headerConfig)):null;return(0,_mithril2["default"])(".headerContainer",{config:initHeaderContainer},[(0,_mithril2["default"])(".bg-container",[(0,_mithril2["default"])(".condensedHeaderBg"),(0,_mithril2["default"])(".headerBg"),(0,_mithril2["default"])(".image-dimmer")]),header,ctrl.mode==="seamed"||ctrl.shadow===false?null:(0,_mithril2["default"])(".dropShadow")])};var createViewContent=function createViewContent(ctrl,scrollConfig){var opts=arguments.length<=2||arguments[2]===undefined?{}:arguments[2];var initMainContainer=function initMainContainer(mainContainer,inited){if(inited){return}if(scrollConfig.main){ctrl.scrollerElem=mainContainer}};return[(0,_mithril2["default"])(".mainContainer.flex",{config:initMainContainer,onscroll:scrollConfig.main},opts.content?opts.content:null)]};var createView=function createView(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var scrollConfig=undefined;opts.header=opts.header||{};opts.configs=opts.configs||[];ctrl.init(ctrl);var updateContentOnScroll=opts.updateContentOnScroll||false;var ignoreContent=!updateContentOnScroll&&ctrl.isScrolling;var scrollerType=modeConfigs.outerScroll[ctrl.mode]?"outer":"main";var handleScroll=ctrl.handleScroll.bind(ctrl);var header=createViewHeader(ctrl,opts);var tag=opts.tag||"div";scrollConfig={};scrollConfig[scrollerType]=handleScroll;var initOuterContainer=function initOuterContainer(outerContainer,inited){var headerElem=outerContainer.querySelector(".header")||outerContainer.querySelector(".toolbar");if(!headerElem){return}if(inited&&ctrl.headerElem){return}var headerContainer=outerContainer.querySelector(".headerContainer");var topBarElem=headerContainer.querySelector(".topBar");var headerBg=headerContainer.querySelector(".headerBg");var condensedHeaderBg=headerContainer.querySelector(".condensedHeaderBg");ctrl.outerContainerElem=outerContainer;ctrl.headerElem=headerElem;ctrl.headerTopBarElem=topBarElem;ctrl.headerBg=headerBg;ctrl.condensedHeaderBg=condensedHeaderBg;if(!opts.animated){ctrl.setHeight(headerContainer.clientHeight)}if(scrollConfig.outer){ctrl.scrollerElem=outerContainer}handleScroll()};var props=Object.assign({},{mode:ctrl.mode,"class":["header-panel",opts.animated?"animated":null,ctrl.fixed?"fixed":null,opts["class"]].join(" "),config:function config(el,inited){if(inited){return}ctrl.headerPanelElem=el}});var content=(0,_mithril2["default"])(".outerContainer.vertical.layout",{config:initOuterContainer,onscroll:scrollConfig.outer},[header,ignoreContent?{subtree:"retain"}:createViewContent(ctrl,scrollConfig,opts)]);return(0,_mithril2["default"])(tag,props,_polythenePolythenePolythene2["default"].insertContent(content,opts))};var component={controller:function controller(){var _this=this;var opts=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var ctrl=undefined,mode=undefined,y=undefined,scrolled=undefined,prevScrollTop=undefined,headerMargin=undefined,headerHeight=undefined;if(opts.mode){mode=opts.mode}else if(opts.header.toolbar){mode=opts.header.toolbar.mode}else if(opts.header.content){mode=opts.header.mode}mode=mode||"standard";var isTouch=!document.documentElement.classList.contains("no-touch");var tall=modeConfigs.tallMode[mode]||false;var tallClass=opts.tallClass||"tall";var animated=opts.animated||false;var fixed=opts.fixed||false;var condenses=opts.condenses||false;var scrollAwayTopbar=opts.scrollAwayTopbar||false;var noReveal=opts.noReveal||false;var keepCondensedHeader=opts.keepCondensedHeader||false;var noDissolve=opts.noDissolve||false;var backgroundScrollSpeed=opts.backgroundScrollSpeed!==undefined?opts.backgroundScrollSpeed:.5;y=0;scrolled=false;prevScrollTop=0;var shadowHeight=DEFAULT_SHADOW_HEIGTH;headerHeight=(opts.headerHeight||DEFAULT_HEADER_HEIGHT)+shadowHeight;var condensedHeaderHeight=(opts.condensedHeaderHeight||DEFAULT_CONDENSED_HEADER_HEIGHT)+shadowHeight;headerMargin=headerHeight-condensedHeaderHeight;var handleScrollFns={standard:function standard(){},fixed:function fixed(){var sTop=undefined,isScrolled=undefined;sTop=ctrl.scrollerElem.scrollTop;isScrolled=sTop!==0;ctrl.showShadow(isScrolled);scrolled=isScrolled},animated:function animated(){var sTop=undefined,isScrolled=undefined,headerElem=undefined;sTop=ctrl.scrollerElem.scrollTop;isScrolled=sTop!==0;if(isScrolled!==scrolled){headerElem=ctrl.headerElem;if(headerElem&&tall){headerElem.classList[isScrolled?"remove":"add"](tallClass)}ctrl.showShadow(isScrolled);scrolled=isScrolled}},dynamicHeader:function dynamicHeader(){var sy=undefined,cascaded=false;var sTop=ctrl.scrollerElem.scrollTop;if(sTop<headerMargin){sy=sTop}else{sy=Math.min(keepCondensedHeader?headerMargin:headerHeight,Math.max(0,noReveal||keepCondensedHeader?sTop:y+sTop-prevScrollTop));if(condenses&&prevScrollTop>=sTop&&sTop>headerMargin){sy=Math.max(sy,headerMargin)}}if(sy>0){ctrl.transformHeader(sy)}else if(isTouch){ctrl.enlargeImage(sy)}if(!modeConfigs.noShadow[opts.mode]){if(sTop>sy){cascaded=true}ctrl.showShadow(cascaded)}y=sy;prevScrollTop=Math.max(sTop,0)}};return{headerPanelElem:undefined,scrollerElem:undefined,outerContainerElem:undefined,headerContainerElem:undefined,headerTopBarElem:undefined,headerElem:undefined,headerBg:undefined,condensedHeaderBg:undefined,mode:mode,fixed:fixed,shadow:opts.shadow!==undefined&&!opts.shadow?false:true,scrollWatchId:0,isScrolling:false,headerConfig:{tall:tall,tallClass:tallClass,animated:animated,fixed:fixed},init:function init(controller){ctrl=controller},setHeight:function setHeight(h){var mainContainer=undefined;if(opts.headerHeight===undefined){headerHeight=h+shadowHeight;headerMargin=headerHeight-condensedHeaderHeight}if(!fixed){mainContainer=ctrl.outerContainerElem.querySelector(".mainContainer");mainContainer.style.paddingTop=h+"px"}if(noReveal){ctrl.showShadow(false)}},handleScroll:function handleScroll(e){var fn=undefined;if(e){ctrl.isScrolling=true;scroller=ctrl;clearTimeout(ctrl.scrollWatchId);ctrl.scrollWatchId=setTimeout(function(){ctrl.isScrolling=false;scroller=undefined},SCROLL_WATCH_TIMER)}if(mode==="scroll"){return}if(modeConfigs.alwaysShadow[mode]){ctrl.showShadow(true)}if(animated){fn=handleScrollFns.animated;fn.bind(_this).call()}if(mode==="standard"){fn=handleScrollFns.standard}else if(fixed){fn=handleScrollFns.fixed}else{fn=handleScrollFns.dynamicHeader}fn.bind(_this).call();if(e&&opts.scroll){opts.scroll(e)}},condenseHeader:function condenseHeader(hy){var hbg=undefined,chbg=undefined;var reset=hy===null;if(!scrollAwayTopbar){if(ctrl.headerTopBarElem){translateY(ctrl.headerTopBarElem.style,Math.min(hy,headerMargin))}}hbg=ctrl.headerBg.style;if(hbg){if(!noDissolve){hbg.opacity=reset?"":(headerMargin-hy)/headerMargin}translateY(hbg,reset?null:hy*backgroundScrollSpeed);if(!noDissolve){chbg=ctrl.condensedHeaderBg.style;chbg.opacity=reset?"":hy/headerMargin;translateY(chbg,reset?null:hy*backgroundScrollSpeed)}}},transformHeader:function transformHeader(hy){if(hy<0){return}translateY(ctrl.headerContainerElem.style,-hy);if(condenses){ctrl.condenseHeader(hy)}if(opts.transform){opts.transform({y:hy,height:headerHeight,condensedHeight:condensedHeaderHeight})}},enlargeImage:function enlargeImage(hy){ctrl.headerBg.style.height=100/headerHeight*(headerHeight+Math.abs(hy/2))+"%"},showShadow:function showShadow(cascaded){if(modeConfigs.alwaysShadow[mode]){cascaded=true}ctrl.outerContainerElem.classList[cascaded?"add":"remove"]("cascaded")}}},view:function view(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];if(scroller&&scroller!==ctrl){return{subtree:"retain"}}else{return createView(ctrl,opts)}}};exports["default"]=component;module.exports=exports["default"];