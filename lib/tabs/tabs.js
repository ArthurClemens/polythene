"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}require("polythene/common/object.assign");var _polythenePolythenePolythene=require("polythene/polythene/polythene");var _polythenePolythenePolythene2=_interopRequireDefault(_polythenePolythenePolythene);var _mithril=require("mithril");var _mithril2=_interopRequireDefault(_mithril);var _polytheneButtonButton=require("polythene/button/button");var _polytheneButtonButton2=_interopRequireDefault(_polytheneButtonButton);var _polytheneIconIcon=require("polythene/icon/icon");var _polytheneIconIcon2=_interopRequireDefault(_polytheneIconIcon);var _polytheneIconButtonIconButton=require("polythene/icon-button/icon-button");var _polytheneIconButtonIconButton2=_interopRequireDefault(_polytheneIconButtonIconButton);var _polytheneCommonScrollTo=require("polythene/common/scrollTo");var _polytheneCommonScrollTo2=_interopRequireDefault(_polytheneCommonScrollTo);require("polythene-theme/tabs/tabs");var SLIDE_DURATION=250;var SCROLL_DURATION=380;var POSITION_LEFT=1<<1;var POSITION_RIGHT=1<<2;var createScrollButton=function createScrollButton(ctrl,position,opts){return _mithril2["default"].component(_polytheneIconButtonIconButton2["default"],{"class":["scroll-btn",position===POSITION_LEFT?"scroll-btn-left":"scroll-btn-right"].join(" "),icon:position===POSITION_LEFT?opts.scrollIconLeft:opts.scrollIconRight,ripple:{center:true},config:function config(el,inited){if(inited){return}if(position===POSITION_LEFT){ctrl.scrollButtonLeftEl=el}else{ctrl.scrollButtonRightEl=el}}})};var setTabMaxWidth=function setTabMaxWidth(ctrl){var tabsElWidth=ctrl.tabsEl.getBoundingClientRect().width;var maxWidth=Math.min(tabsElWidth-56,264);ctrl.tabs.forEach(function(tab){return tab.style.maxWidth=maxWidth+"px"})};var alignToTitle=function alignToTitle(ctrl){var firstTab=ctrl.tabs[0];var firstInnerLabel=firstTab.querySelector(".label span");var firstOuterLabelWidth=firstTab.getBoundingClientRect().width;var firstInnerLabelWidth=firstInnerLabel.getBoundingClientRect().width;var firstTabOffset=(firstOuterLabelWidth-firstInnerLabelWidth)/2;firstTab.style.marginLeft=-firstTabOffset+"px"};var createRightButtonOffset=function createRightButtonOffset(ctrl){var scrollButtonRightWidth=ctrl.scrollButtonRightEl.getBoundingClientRect().width;var scrollButtonOffsetEl=ctrl.tabsEl.querySelector(".scrollButtonOffset");scrollButtonOffsetEl.style.width=scrollButtonRightWidth+"px"};var scrollToTab=function scrollToTab(tabIndex,tabs,scroller){var left=tabs.slice(0,tabIndex).reduce(function(width,el){return width+el.getBoundingClientRect().width},0);(0,_polytheneCommonScrollTo2["default"])({element:scroller,to:left,duration:SCROLL_DURATION,which:"scrollLeft"})};var updateScrollButtons=function updateScrollButtons(ctrl){var scrollerEl=ctrl.scrollerEl;var scrollLeft=scrollerEl.scrollLeft;var currentTabIndex=ctrl.selectedTabIndex();var tabs=ctrl.tabs;var tabsEl=ctrl.tabsEl;var scrollButtonLeftEl=ctrl.scrollButtonLeftEl;var scrollButtonRightEl=ctrl.scrollButtonRightEl;var minTabIndex=0;var maxTabIndex=tabs.length-1;var isAtLeft=scrollerEl.scrollLeft===0&&currentTabIndex===minTabIndex;var isAtRight=scrollLeft>=scrollerEl.scrollWidth-tabsEl.getBoundingClientRect().width-1&&currentTabIndex===maxTabIndex;if(isAtLeft&&!ctrl.isLeft){ctrl.isLeft=true;scrollButtonLeftEl.classList.add("inactive")}else if(!isAtLeft&&ctrl.isLeft){ctrl.isLeft=false;scrollButtonLeftEl.classList.remove("inactive")}else if(isAtRight&&!ctrl.isRight){ctrl.isRight=true;scrollButtonRightEl.classList.add("inactive")}else if(!isAtRight&&ctrl.isRight){ctrl.isRight=false;scrollButtonRightEl.classList.remove("inactive")}};var manageScroll=function manageScroll(ctrl,context){var minTabIndex=0;var maxTabIndex=ctrl.tabs.length-1;var tabs=ctrl.tabs;var scrollerEl=ctrl.scrollerEl;var scrollButtonLeftEl=ctrl.scrollButtonLeftEl;var scrollButtonRightEl=ctrl.scrollButtonRightEl;var getNewIndex=function getNewIndex(index){return{left:Math.max(index-1,minTabIndex),right:Math.min(index+1,maxTabIndex)}};var handleScrollButtonClick=function handleScrollButtonClick(e,direction){e.stopPropagation();e.preventDefault();var currentTabIndex=ctrl.selectedTabIndex();var newIndex=getNewIndex(currentTabIndex)[direction];scrollToTab(newIndex,tabs,scrollerEl);if(newIndex!==currentTabIndex){setSelectedTab(newIndex,true,ctrl)}updateScrollButtons(ctrl)};var onLeftScrollButtonClick=function onLeftScrollButtonClick(e){handleScrollButtonClick(e,"left")};var onRightScrollButtonClick=function onRightScrollButtonClick(e){handleScrollButtonClick(e,"right")};var onScroll=function onScroll(){updateScrollButtons(ctrl)};createRightButtonOffset(ctrl);scrollButtonLeftEl.addEventListener("click",onLeftScrollButtonClick,false);scrollButtonRightEl.addEventListener("click",onRightScrollButtonClick,false);scrollerEl.addEventListener("scroll",onScroll);context.onunload=function(){scrollerEl.removeEventListener("scroll",onScroll);scrollButtonLeftEl.removeEventListener("click",onLeftScrollButtonClick,false);scrollButtonRightEl.removeEventListener("click",onRightScrollButtonClick,false)}};var setSelectedTab=function setSelectedTab(index,animate,ctrl){ctrl.selectedTabIndex(index);var selectedTabEl=ctrl.tabs[index];if(selectedTabEl&&ctrl.tabIndicatorEl&&ctrl.tabsEl){var parentRect=ctrl.tabsEl.getBoundingClientRect();var rect=selectedTabEl.getBoundingClientRect();var style=ctrl.tabIndicatorEl.style;var scaleX=1/parentRect.width*rect.width;var translateX=(rect.left-parentRect.left+ctrl.scrollerEl.scrollLeft)/scaleX;var transformCmd="scaleX("+scaleX+") translate("+translateX+"px)";var duration=animate?SLIDE_DURATION:0;style["transition-duration"]=style["-webkit-transition-duration"]=style["-moz-transition-duration"]=style["-o-transition-duration"]=duration+"ms";style.transform=style["-webkit-transform"]=style["-moz-transform"]=style["-o-transform"]=transformCmd}if(ctrl.managesScroll){updateScrollButtons(ctrl)}};var createTab=function createTab(index,opts,tabsOpts,ctrl){var autofit=tabsOpts.scrollable||tabsOpts.centered?false:tabsOpts.autofit?true:false;var tabIcon=opts.icon?_mithril2["default"].component(_polytheneIconIcon2["default"],opts.icon):null;var tabButtonOptions=Object.assign({},{content:(0,_mithril2["default"])(".layout.vertical",[(0,_mithril2["default"])(".flex"),tabIcon,(0,_mithril2["default"])(".label",(0,_mithril2["default"])("span",opts.label)),(0,_mithril2["default"])(".flex")]),"class":["tab",autofit?"flex":"flex none",opts.icon&&opts.label?"hasIconLabel":null,opts["class"]].join(" "),wash:false,events:{onclick:function onclick(){return setSelectedTab(index,tabsOpts.noIndicatorSlide?false:true,ctrl)}},config:function config(el,inited){if(inited){return}ctrl.tabs.push(el)}},opts,tabsOpts.tabOpts||{});return _mithril2["default"].component(_polytheneButtonButton2["default"],tabButtonOptions)};var createView=function createView(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var tag=opts.tag||"div";var props={"class":["tabs",opts.scrollable?"scrollable":null,opts["class"]].join(" "),config:function config(el,inited,context){if(inited){return}ctrl.tabsEl=el;if(opts.largestWidth){(function(){var widths=ctrl.tabs.map(function(tab){return tab.getBoundingClientRect().width}).sort();var largest=widths[0];ctrl.tabs.forEach(function(tab){return tab.style.width=largest+"px"})})()}setTabMaxWidth(ctrl);if(opts.scrollable){alignToTitle(ctrl)}if(opts.scrollable&&document.documentElement.classList.contains("no-touch")){ctrl.managesScroll=true;manageScroll(ctrl,context)}var onResize=function onResize(){setSelectedTab(ctrl.selectedTabIndex(),false,ctrl);_mithril2["default"].redraw()};_polythenePolythenePolythene2["default"].addListener("resize",onResize);context.onunload=function(){_polythenePolythenePolythene2["default"].removeListener("resize",onResize)};setTimeout(function(){setSelectedTab(opts.selectedTab||0,false,ctrl)},0)}};var tabRow=opts.buttons.map(function(buttonOpts,index){buttonOpts=Object.assign(buttonOpts,{selected:index===ctrl.selectedTabIndex(),animateOnTap:false});return createTab(index,buttonOpts,opts,ctrl)}).concat([(0,_mithril2["default"])(".scrollButtonOffset.flex.none")]);var scrollButtonLeft=undefined,scrollButtonRight=undefined;if(opts.scrollable){scrollButtonLeft=createScrollButton(ctrl,POSITION_LEFT,opts);scrollButtonRight=createScrollButton(ctrl,POSITION_RIGHT,opts)}var content=[opts.scrollable?scrollButtonLeft:null,(0,_mithril2["default"])("div",{"class":["tabRow layout horizontal",opts.scrollable?"indent":null].join(" "),config:function config(el,inited){if(inited){return}ctrl.scrollerEl=el}},[opts.centered?(0,_mithril2["default"])(".flex"):null,tabRow,opts.hideIndicator?null:(0,_mithril2["default"])(".tabIndicator",{config:function config(el,inited){if(inited){return}ctrl.tabIndicatorEl=el}}),opts.centered?(0,_mithril2["default"])(".flex"):null]),opts.scrollable?scrollButtonRight:null];return(0,_mithril2["default"])(tag,props,_polythenePolythenePolythene2["default"].insertContent(content,opts))};var component={controller:function controller(){return{tabsEl:null,scrollerEl:null,tabs:[],tabIndicatorEl:null,selectedTabIndex:_mithril2["default"].prop(0),isLeft:false,isRight:false,managesScroll:false}},view:function view(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];return createView(ctrl,opts)}};exports["default"]=component;module.exports=exports["default"];