"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),require("polythene/common/object.assign");var _polythene=require("polythene/polythene/polythene"),_polythene2=_interopRequireDefault(_polythene),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril);require("polythene/slider/theme/theme");var _config=require("polythene/slider/theme/config"),_config2=_interopRequireDefault(_config),_isomorphic=require("polythene/common/isomorphic"),_isomorphic2=_interopRequireDefault(_isomorphic),CSS_CLASSES={block:"pe-slider",thumb:"pe-slider__thumb",label:"pe-slider__label",track:"pe-slider__track",trackPart:"pe-slider__track-part",trackPartValue:"pe-slider__track-value",trackPartRest:"pe-slider__track-rest",trackBar:"pe-slider__track-bar",trackBarValue:"pe-slider__track-bar-value",control:"pe-slider__control",ticks:"pe-slider__ticks",tick:"pe-slider__ticks-tick",pin:"pe-slider__pin",isDisabled:"pe-slider--disabled",isActive:"pe-slider--active",hasTrack:"pe-slider--track",hasPin:"pe-slider--pin",hasFocus:"pe-slider--focus",isAtMin:"pe-slider--min",hasTicks:"pe-slider--ticks"},focusElement=void 0,eventMoveType="mousemove",eventEndType="mouseup";_isomorphic2.default.isClient()&&(eventMoveType=window.PointerEvent?"pointermove":"ontouchmove"in window||window.DocumentTouch&&document instanceof DocumentTouch?"touchmove":"mousemove",eventEndType=window.PointerEvent?"pointerup":"ontouchend"in window||window.DocumentTouch&&document instanceof DocumentTouch?"touchend":"mouseup");var deFocus=function(ctrl){focusElement&&focusElement.blur(),focusElement=void 0,ctrl.hasFocus=!1},focus=function(ctrl,el){deFocus(ctrl),focusElement=el,ctrl.hasFocus=!0},positionFromEvent=function(e,isVertical){return _polythene2.default.isTouch?isVertical?e.touches[0].pageY:e.touches[0].pageX:isVertical?e.pageY:e.pageX},updatePinPosition=function(ctrl){if(ctrl.controlEl&&ctrl.pinEl){var left=ctrl.fraction()*ctrl.rangeWidth;ctrl.pinEl.style.left=left+"px"}},updateValue=function(ctrl,value){ctrl.setValue(value),updatePinPosition(ctrl)},generateTickMarks=function(min,max,stepSize){for(var steps=Math.round((max-min)/stepSize),items=[],s=steps+1;s>0;)items.push((0,_mithril2.default)("div",{class:CSS_CLASSES.tick})),s--;return items},readRangeData=function(ctrl){if(ctrl.controlEl){ctrl.controlWidth=_config2.default.thumb_size,ctrl.rangeWidth=ctrl.trackEl.getBoundingClientRect().width-ctrl.controlWidth;var styles=window.getComputedStyle(ctrl.trackEl);ctrl.rangeOffset=parseFloat(styles.marginLeft)}},calculateClickOffset=function(ctrl){var controlOffset=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;ctrl.clickOffset=ctrl.trackEl.getBoundingClientRect().left-(ctrl.rangeOffset-ctrl.controlWidth/2)+controlOffset},initControlEvent=function(ctrl,e){var controlPos=ctrl.controlEl.getBoundingClientRect().left,eventPos=positionFromEvent(e),controlOffset=eventPos-controlPos-ctrl.controlWidth/2;calculateClickOffset(ctrl,controlOffset)},initTrackEvent=function(ctrl){calculateClickOffset(ctrl,0)},handlePosEvent=function(ctrl,e){var pos=positionFromEvent(e)-ctrl.clickOffset,value=ctrl.min+(pos-ctrl.rangeOffset)/ctrl.rangeWidth*(ctrl.max-ctrl.min);updateValue(ctrl,value),_mithril2.default.redraw()},startDrag=function(ctrl,opts,e){if(!_isomorphic2.default.isServer()&&!ctrl.isDragging){e.preventDefault(),ctrl.isDragging=!0,ctrl.isActive=!0,deFocus(ctrl);var drag=function(e){ctrl.isDragging&&handlePosEvent(ctrl,e)},endDrag=function endDrag(){ctrl.isDragging&&(ctrl.isDragging=!1,ctrl.isActive=!1,deFocus(ctrl),window.removeEventListener(eventMoveType,drag),window.removeEventListener(eventEndType,endDrag),_mithril2.default.redraw())};window.addEventListener(eventMoveType,drag),window.addEventListener(eventEndType,endDrag),readRangeData(ctrl),opts.pin&&updatePinPosition(ctrl)}},startTrack=function(ctrl,opts,e){e.preventDefault(),ctrl.isDragging||(readRangeData(ctrl),initTrackEvent(ctrl),handlePosEvent(ctrl,e),startDrag(ctrl,opts,e))},createSlider=function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},hasTicks=arguments[2],interactiveTrack=arguments[3],fraction=ctrl.fraction(),stepCount=Math.max(10,parseInt(opts.step,10)||1),onStartTrack=function(e){startTrack(ctrl,opts,e)},onInitDrag=function(e){readRangeData(ctrl),initControlEvent(ctrl,e),startDrag(ctrl,opts,e)},flexValueCss=fraction+" 1 0%",flexRestValue=1-fraction,flexRestCss=flexRestValue+" 1 0%";return[(0,_mithril2.default)("div",Object.assign({},{class:CSS_CLASSES.track,config:function(el,inited){inited||(ctrl.trackEl=el,opts.pin&&setTimeout(function(){updatePinPosition(ctrl)},0))}},!interactiveTrack||opts.disabled||_polythene2.default.isTouch?null:{onmousedown:onStartTrack},interactiveTrack&&!opts.disabled&&_polythene2.default.isTouch?{ontouchstart:onStartTrack}:null),[(0,_mithril2.default)("div",{class:CSS_CLASSES.trackPart+" "+CSS_CLASSES.trackPartValue,style:{flex:flexValueCss,"-ms-flex":flexValueCss,webkitFlex:flexValueCss}},(0,_mithril2.default)("div",{class:CSS_CLASSES.trackBar},(0,_mithril2.default)("div",{class:CSS_CLASSES.trackBarValue}))),(0,_mithril2.default)("div",Object.assign({},{class:CSS_CLASSES.control,config:function(el,inited){inited||(ctrl.controlEl=el)}},opts.disabled?{disabled:!0}:{tabindex:opts.tabindex||0,onfocus:function(){focus(ctrl,ctrl.controlEl)},onblur:function(){deFocus(ctrl)},onkeydown:function(e){27===e.which?ctrl.controlEl.blur(e):37===e.which?ctrl.decrease(e.shiftKey):38===e.which?ctrl.increase(e.shiftKey):39===e.which?ctrl.increase(e.shiftKey):40===e.which&&ctrl.decrease(e.shiftKey),readRangeData(ctrl),updatePinPosition(ctrl)}},opts.disabled||_polythene2.default.isTouch?null:{onmousedown:onInitDrag},!opts.disabled&&_polythene2.default.isTouch?{ontouchstart:onInitDrag}:null,opts.events?opts.events:null,hasTicks?{step:stepCount}:null),opts.icon?(0,_mithril2.default)("div",{class:CSS_CLASSES.thumb},opts.icon):null),(0,_mithril2.default)("div",{class:CSS_CLASSES.trackPart+" "+CSS_CLASSES.trackPartRest,style:{flex:flexRestCss,"-ms-flex":flexRestCss,webkitFlex:flexRestCss,"max-width":100*flexRestValue+"%"}},(0,_mithril2.default)("div",{class:CSS_CLASSES.trackBar},(0,_mithril2.default)("div",{class:CSS_CLASSES.trackBarValue}))),hasTicks&&!opts.disabled?(0,_mithril2.default)("div",{class:CSS_CLASSES.ticks},generateTickMarks(ctrl.min,ctrl.max,stepCount)):null,hasTicks&&opts.pin&&!opts.disabled?(0,_mithril2.default)("div",{class:CSS_CLASSES.pin,value:Math.round(ctrl.value()),config:function(el,inited){inited||(ctrl.pinEl=el)}}):null])]},createView=function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"function"==typeof opts.value&&ctrl.setValue(opts.value());var tag=opts.tag||"div",hasTicks=void 0!==opts.ticks&&opts.ticks!==!1,interactiveTrack=void 0===opts.interactiveTrack||opts.interactiveTrack,props={class:[CSS_CLASSES.block,opts.disabled?CSS_CLASSES.isDisabled:null,opts.pin?CSS_CLASSES.hasPin:null,interactiveTrack?CSS_CLASSES.hasTrack:null,ctrl.isActive?CSS_CLASSES.isActive:null,ctrl.hasFocus?CSS_CLASSES.hasFocus:null,0===ctrl.fraction()?CSS_CLASSES.isAtMin:null,hasTicks?CSS_CLASSES.hasTicks:null,opts.class].join(" "),id:opts.id||"",config:opts.config},content=createSlider(ctrl,opts,hasTicks,interactiveTrack);return(0,_mithril2.default)(tag,props,[opts.before,content,opts.after])},component={controller:function(){var opts=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},min=void 0!==opts.min?opts.min:0,max=void 0!==opts.max?opts.max:100,step=void 0!==opts.step?opts.step:1,defaultValue=0,_fraction=min,_value=defaultValue;if("function"==typeof opts.value){var v=opts.value();_value=void 0!==v?v:defaultValue}else _value=void 0!==opts.value?opts.value:defaultValue;var setValue=function(v){v<min&&(v=min),v>max&&(v=max),_value=step?Math.round(v/step)*step:v,_fraction=(_value-min)/(max-min),opts.getValue&&opts.getValue(_value)};return setValue(_value),{min:min,max:max,trackEl:null,controlEl:null,pinEl:null,setValue:setValue,value:function(){return _value},fraction:function(){return _fraction},increase:function(multiply){return setValue(_value+(multiply?10:1)*(step||1))},decrease:function(multiply){return setValue(_value-(multiply?10:1)*(step||1))},isActive:!1,hasFocus:!1,isDragging:!1,controlWidth:0,rangeWidth:0,rangeOffset:0,clickOffset:0}},view:function(ctrl){var opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return createView(ctrl,opts)}};exports.default=component,module.exports=exports.default;
//# sourceMappingURL=slider.js.map